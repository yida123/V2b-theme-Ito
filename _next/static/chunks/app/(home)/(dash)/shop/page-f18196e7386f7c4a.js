(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[394],{6659:(e,t,a)=>{Promise.resolve().then(a.bind(a,53194))},53194:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>q});var r=a(95155),i=a(12115);let s=i.forwardRef((e,t)=>{let{label:a,value:i,children:s,...l}=e;return(0,r.jsxs)("div",{ref:t,className:"flex items-center justify-between py-1",...l,children:[(0,r.jsx)("div",{className:"text-small text-default-500",children:a}),(0,r.jsx)("div",{className:"text-small  font-semibold text-default-700",children:i||s})]})});s.displayName="CellValue";let l=()=>(0,r.jsxs)("div",{className:"flex flex-row gap-2",children:[(0,r.jsx)("div",{className:"w-4 h-4 rounded-full bg-primary-700 animate-bounce"}),(0,r.jsx)("div",{className:"w-4 h-4 rounded-full bg-primary-700 animate-bounce [animation-delay:-.3s]"}),(0,r.jsx)("div",{className:"w-4 h-4 rounded-full bg-primary-700 animate-bounce [animation-delay:-.5s]"})]});var n=a(59568),c=a(90996);let d={month_price:"月付",quarter_price:"季付",half_year_price:"半年付",year_price:"年付",two_year_price:"两年付",three_year_price:"三年付",onetime_price:"流量包",reset_price:"重置流量",deposit:"充值"},o=e=>e.month_price?"month_price":e.quarter_price?"quarter_price":e.half_year_price?"half_year_price":e.year_price?"year_price":e.two_year_price?"two_year_price":e.three_year_price?"three_year_price":e.onetime_price?"onetime_price":"reset_price",u=["month_price","quarter_price","half_year_price","year_price","two_year_price","three_year_price","onetime_price","reset_price"];var p=a(18850),m=a(10168),h=a(63162),f=a(75243),x=a(22708),g=a(30855),_=a(65701),y=a(15471),j=a(85812),b=a(43350),w=a(77520),v=a(84520),N=a(1493),S=a(54783),A=a(39436),I=a(86613),k=a(66749),C=a(74369),E=a(97376),L=a(17168),O=a(38924),R=a(35695),F=a(56671),P=a(60838);let T=a(39022)({html:!0,linkify:!0,breaks:!0,typographer:!0,listIndent:!0});function q(){let e=(0,R.useRouter)(),{request:t}=(0,n.A)(),a=(0,R.useSearchParams)(),{data:q}=(0,P.Ay)("user/plan/fetch"),{data:z}=(0,P.Ay)("user/order/getPaymentMethod"),[B,U]=(0,i.useState)(),{isOpen:W,onOpen:V,onOpenChange:D}=(0,p.j)(),[M,G]=(0,i.useTransition)(),H=e=>{U(void 0),V(),G(async()=>{try{let{data:a}=await t.get("user/plan/fetch?id=".concat(e));if(null!==a.data.capacity_limit&&a.data.capacity_limit<=0)throw Error("该订阅已售罄");U(a.data)}catch(e){F.oR.error((0,c.A)(e))}})};(0,i.useEffect)(()=>{let e=a.get("id");if(e){let t=parseInt(e,10);isNaN(t)||H(t)}},[a]);let[J,Y]=(0,i.useState)("month_price");(0,i.useEffect)(()=>{if(!B)return;let e=a.get("reset"),t=a.get("id");"true"===e&&null!==t&&B.reset_price?Y("reset_price"):Y(o(B))},[B,a]);let[Z,K]=(0,i.useState)(),[Q,X]=(0,i.useTransition)();(0,i.useEffect)(()=>{if(Z&&Z.limit_period&&!Z.limit_period.includes(J)){F.oR.error("该优惠码不适用于当前订阅"),K(void 0);return}},[J,Z]);let[$,ee]=(0,i.useState)("");(0,i.useEffect)(()=>{z&&z.data&&(z.data.length>0?ee(z.data[0].id.toString()):ee(""))},[z]);let et=()=>B&&J?B[J]:0,ea=()=>Z&&et()?1===Z.type?et()-Z.value<0?0:et()-Z.value:et()*(1-Z.value/100):0,er=()=>{let e=Z?ea():et();if(!e||!$||!z)return 0;let t=0,a=z.data.find(e=>$==e.id.toString());return a&&(a.handling_fee_percent&&(t=e*parseFloat(a.handling_fee_percent)/100),a.handling_fee_fixed&&(t+=parseInt(a.handling_fee_fixed))),t},[ei,es]=(0,i.useTransition)(),el=e=>{var t,a;return(0,r.jsxs)(m.Z,{fullWidth:!0,radius:"lg",className:"flex flex-col text-left p-4 gap-4 border border-default-200 min-h-[120px] justify-between",shadow:"none",children:[(0,r.jsxs)(h.d,{className:"flex flex-col gap-2 items-start",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center w-full",children:[(0,r.jsx)("span",{className:"font-bold text-xl truncate",children:e.name}),null!=e.capacity_limit&&e.capacity_limit<=10&&(0,r.jsx)(f.R,{color:e.capacity_limit>0?"warning":"danger",variant:"flat",size:"sm",children:e.capacity_limit>0?"仅剩 "+e.capacity_limit+" 份":"售罄"})]}),(0,r.jsxs)("span",{className:"text-base/7 text-default-500",children:["包含"," ",(0,r.jsxs)("span",{className:"font-bold text-primary",children:[e.transfer_enable," GB"]})," ","流量"]}),(0,r.jsxs)("p",{className:"flex items-baseline gap-x-2 text-default-900",children:[(0,r.jsx)("span",{className:"text-5xl font-semibold tracking-tight",children:e[o(e)]?"\xa5 "+((null!=(t=e[o(e)])?t:0)/100).toFixed(2):"免费"}),(0,r.jsxs)("span",{className:"text-base",children:["/ ",d[o(e)]]})]})]}),(0,r.jsx)(x.U,{children:(a=e.content)?(()=>{try{let e=JSON.parse(a);if(Array.isArray(e))return!0;return!1}catch(e){return!1}})()?(0,r.jsx)("ul",{className:"flex flex-col gap-2",children:JSON.parse(a).map((e,t)=>(0,r.jsxs)("li",{className:"flex items-center gap-2",children:[e.support?(0,r.jsx)(L.A,{className:"text-primary min-w-[24px]",width:24}):(0,r.jsx)(O.A,{className:"text-danger min-w-[24px]",width:24}),(0,r.jsx)("p",{className:"text-default-500",children:e.feature})]},t))}):/<\/?[a-z][\s\S]*>/i.test(a)?(0,r.jsx)("div",{className:"text-sm text-default-700 html-content",dangerouslySetInnerHTML:{__html:T.render(a)}}):(0,r.jsx)("div",{children:a.split("\n").map((e,t)=>e?(0,r.jsx)("p",{children:e},t):(0,r.jsx)("br",{},t))}):null}),(0,r.jsx)(g.Z,{children:(0,r.jsx)(_.T,{color:"primary",className:"mt-4 p-4",fullWidth:!0,isDisabled:!(null===e.capacity_limit||e.capacity_limit>0)||M,onPress:()=>H(e.id),children:"前往购买"})})]},e.id)};return(0,r.jsxs)("div",{className:"flex flex-col w-full gap-6 sm:gap-12 items-center justify-center",children:[(0,r.jsxs)(y.r,{"aria-label":"Options",variant:"underlined",size:"lg",classNames:{panel:"p-0 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 w-full"},children:[(0,r.jsx)(j.i,{title:"全部订阅",children:q&&q.data?q.data.map(el):null},"all"),(0,r.jsx)(j.i,{title:"循环订阅",children:q&&q.data&&q.data.map(e=>{if("onetime_price"!==o(e))return el(e)})},"period"),(0,r.jsx)(j.i,{title:"流量包订阅",children:q&&q.data&&q.data.map(e=>{if("onetime_price"===o(e))return el(e)})},"one-time")]}),(0,r.jsx)(b.Y,{isOpen:W,onOpenChange:D,radius:"lg",hideCloseButton:!0,scrollBehavior:"inside",children:(0,r.jsx)(w.g,{children:B?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(v.c,{children:["套餐详情：",B.name]}),(0,r.jsxs)(N.h,{children:[(0,r.jsx)(s,{label:"套餐流量",value:B.transfer_enable+" GB"}),(0,r.jsx)(S.U,{label:"选择周期",value:J,onValueChange:Y,className:"text-sm",classNames:{wrapper:"grid grid-cols-3 gap-4"},children:"reset_price"===J?(0,r.jsx)(A.O,{value:"reset_price",classNames:{wrapper:"hidden",label:"text-sm",base:(0,I.cn)("m-0 bg-content1 hover:border-default-400 items-center justify-between","min-w-full cursor-pointer rounded-medium5 p-2 border-1 border-default","data-[selected=true]:border-primary","!duration-150 transition-colors")},children:d.reset_price},"reset_price"):u.filter(e=>null!==B[e]).map(e=>{var t;return"reset_price"===e?null:(0,r.jsx)(A.O,{value:e,description:"\xa5 "+((null!=(t=B[e])?t:0)/100).toFixed(2),classNames:{wrapper:"hidden",label:"text-sm",base:(0,I.cn)("m-0 bg-content1 hover:border-default-400 items-center justify-between","min-w-full cursor-pointer rounded-medium p-2 border-1 border-default","data-[selected=true]:border-primary","!duration-150 transition-colors")},children:d[e]},e)})}),(0,r.jsx)(S.U,{label:"支付方式",value:$,onValueChange:ee,className:"text-sm",children:z&&z.data&&z.data.map(e=>(0,r.jsx)(A.O,{value:e.id.toString(),classNames:{label:"text-sm",base:(0,I.cn)("m-0 bg-content1 hover:border-default-400 items-center justify-between","flex-row-reverse min-w-full cursor-pointer rounded-medium p-2 border-1 border-default","data-[selected=true]:border-primary","!duration-150 transition-colors")},children:e.name},e.id))}),(0,r.jsxs)(k.l,{className:"flex flex-row items-end gap-2",onSubmit:e=>{e.preventDefault();let a=Object.fromEntries(new FormData(e.currentTarget));X(async()=>{if(a.coupon)try{let e=await t.post("user/coupon/check",{code:a.coupon,plan_id:B.id}),r=e.data.data;if(r.limit_period&&!r.limit_period.includes(J))throw Error("优惠码不适用于当前周期");K(e.data.data),F.oR.success("优惠码验证成功")}catch(e){K(void 0),F.oR.error((0,c.A)(e))}})},children:[(0,r.jsx)(C.r,{name:"coupon",fullWidth:!0,size:"sm",variant:"bordered",label:"优惠码",labelPlacement:"outside",placeholder:"如果有优惠码可以在此输入",radius:"md",classNames:{input:"text-xs",label:"group-data-[filled-within=true]:text-default-500 text-sm",helperWrapper:"h-4"}}),(0,r.jsx)(_.T,{radius:"md",color:"primary",variant:"flat",size:"sm",type:"submit",isLoading:Q,children:!Q&&"验证"})]}),(0,r.jsx)(s,{label:"套餐金额",value:"\xa5 "+(et()/100).toFixed(2)}),ea()>0&&(0,r.jsx)(s,{label:"优惠金额",value:"- \xa5 "+((et()-ea())/100).toFixed(2)}),er()>0&&(0,r.jsx)(s,{label:"支付手续费",value:"\xa5 "+(er()/100).toFixed(2)}),(0,r.jsx)(s,{label:"支付总计",value:"\xa5 "+(Z&&(!Z.limit_period||Z.limit_period.some(e=>e===J))?((ea()+er())/100).toFixed(2):((et()+er())/100).toFixed(2))})]}),(0,r.jsx)(E.q,{children:(0,r.jsx)(_.T,{fullWidth:!0,radius:"md",color:"primary",onPress:()=>{es(async()=>{if($&&J&&B)try{let{data:{data:a}}=await t.get("user/order/fetch");if(a.length>0){let e=a[0];0===e.status&&await t.post("user/order/cancel",{trade_no:e.trade_no})}let{data:{data:r}}=await t.post("user/order/save",{plan_id:B.id,period:J,coupon_code:null==Z?void 0:Z.code}),{data:{data:i}}=await t.post("user/order/checkout",{trade_no:r,method:$});!0===i?(F.oR.success("本次订单无需支付，已成功续费"),e.push("/profile")):e.push(i)}catch(e){F.oR.error((0,c.A)(e))}})},isLoading:ei,children:"确认支付"})})]}):(0,r.jsx)("div",{className:"flex flex-col items-center justify-center gap-4 p-8",children:(0,r.jsx)(l,{})})})})]})}},59568:(e,t,a)=>{"use strict";a.d(t,{A:()=>o,O:()=>d});var r=a(95155),i=a(23464),s=a(12115),l=a(60838),n=a(792);let c=(0,s.createContext)(void 0),d=e=>{let{children:t}=e,[a,d]=(0,s.useState)(()=>{let e=localStorage.getItem("auth_data");return{isAuthChecked:!!e,isLoggedIn:!!e}}),[o,u]=(0,s.useState)(),[p,m]=(0,s.useState)();(0,s.useEffect)(()=>{if(!window.settings)return;let{title:e,description:t}=window.settings;document.title="".concat(e," - ").concat(t),window.settings.crisp_id&&n.YH.configure(window.settings.crisp_id),u(window.settings)},[]);let h=(0,s.useMemo)(()=>{if(!o)return;let{api:e}=o,t=i.A.create({baseURL:new URL("/api/v1",e).toString(),timeout:1e4,headers:{"Content-Type":"application/json"}});return t.interceptors.request.use(e=>{let t=localStorage.getItem("auth_data");return t&&(e.headers.Authorization=t),e}),t.interceptors.response.use(e=>e,e=>{var t;return(null==(t=e.response)?void 0:t.status)===403&&(localStorage.removeItem("auth_data"),d(e=>({...e,isLoggedIn:!1}))),Promise.reject(e)}),d(e=>({...e,isAuthChecked:!0})),t},[o]),f=(0,s.useCallback)(async e=>{if(!h)return;let{data:t}=await h.get(e);return t},[h]);(0,s.useEffect)(()=>{h&&localStorage.getItem("auth_data")&&(async()=>{try{await h.get("user/checkLogin"),d(e=>({...e,isLoggedIn:!0}))}catch(e){console.error("Failed to check session:",e)}})()},[h]);let x=(0,s.useCallback)(async()=>{if(h&&!p)try{let e=await h.get("guest/comm/config");m(e.data.data)}catch(e){console.error("Failed to load remote config:",e)}},[h,p]),g=async(e,t)=>{if(h)try{let{data:a}=await h.post("passport/auth/login",{email:e,password:t});localStorage.setItem("auth_data",a.data.auth_data),d(e=>({...e,isLoggedIn:!0}))}catch(e){throw e}},_=async(e,t,a,r)=>{if(h)try{let{data:i}=await h.post("passport/auth/register",{email:e,password:t,email_code:a,invite_code:r});localStorage.setItem("auth_data",i.data.auth_data),d(e=>({...e,isLoggedIn:!0}))}catch(e){throw e}},y=async(e,t,a)=>{if(h)try{await h.post("passport/auth/forget",{email:e,password:t,email_code:a})}catch(e){throw e}},j=async e=>{if(h)try{await h.post("passport/comm/sendEmailVerify",{email:e})}catch(e){throw e}};return(0,r.jsx)(c.Provider,{value:{isAuthChecked:a.isAuthChecked,isLoggedIn:a.isLoggedIn,request:h,config:o,remoteConfig:p,loadRemoteConfig:x,signIn:g,signUp:_,signOut:()=>{localStorage.removeItem("auth_data"),d({isAuthChecked:!0,isLoggedIn:!1})},sendVerifyCode:j,resetPassword:y},children:(0,r.jsx)(l.BE,{value:{fetcher:f,errorRetryCount:1,errorRetryInterval:100},children:t})})},o=()=>{let e=(0,s.useContext)(c);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},90996:(e,t,a)=>{"use strict";a.d(t,{A:()=>i});var r=a(23464);let i=e=>{if(r.A.isAxiosError(e))if(!e.response)return"网络错误，请尝试更换浏览器或者网络环境后再试";else{var t;let a=null==(t=e.response)?void 0:t.data;if(a.message)return a.message}return e instanceof Error?e.message:"未知错误"}}},e=>{e.O(0,[825,84,876,895,979,671,829,215,369,318,572,326,638,441,964,358],()=>e(e.s=6659)),_N_E=e.O()}]);